<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="IndustrialControlMAUI.Pages.InspectionRunDetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:IndustrialControlMAUI.ViewModels"
    Title="ç‚¹å·¡æ£€æ‰§è¡Œ">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- åˆ†åŒºæ ‡é¢˜ -->
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="BackgroundColor" Value="#F5F7FA"/>
                <Setter Property="Padding" Value="10,8"/>
                <Setter Property="TextColor" Value="#111827"/>
            </Style>

            <!-- å¡ç‰‡å®¹å™¨ -->
            <Style x:Key="Card" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="CornerRadius" Value="10"/>
                <Setter Property="HasShadow" Value="False"/>
                <Setter Property="BorderColor" Value="#E5E7EB"/>
                <Setter Property="Margin" Value="0,6,0,10"/>
                <Setter Property="Padding" Value="10"/>
            </Style>

            <!-- è¡¨å¤´ -->
            <Style x:Key="TableHeader" TargetType="Grid">
                <Setter Property="BackgroundColor" Value="#EAF2FF"/>
                <Setter Property="Padding" Value="8,6"/>
            </Style>

            <!-- ä¸»æŒ‰é’®/æ¬¡æŒ‰é’® -->
            <Style x:Key="PrimaryBtn" TargetType="Button">
                <Setter Property="HeightRequest" Value="36"/>
                <Setter Property="CornerRadius" Value="8"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="BackgroundColor" Value="#1677ff"/>
            </Style>
            <Style x:Key="SuccessBtn" TargetType="Button" BasedOn="{StaticResource PrimaryBtn}">
                <Setter Property="BackgroundColor" Value="#22c55e"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>


    <Grid x:Name="RootGrid">

        <!-- ç‚¹å‡»ç©ºç™½å¤„æ”¶èµ·æ£€éªŒå‘˜ä¸‹æ‹‰ -->
        <Grid.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding ClearInspectorCommand}" />
        </Grid.GestureRecognizers>

        <ScrollView>
        <VerticalStackLayout Spacing="8" Padding="12">

            <!-- é¡¶éƒ¨æ“ä½œ -->
            <HorizontalStackLayout HorizontalOptions="End" Spacing="8">
                <Button Text="ä¿å­˜"   Command="{Binding SaveCommand}"    Style="{StaticResource PrimaryBtn}"/>
                <Button Text="å®Œæˆç‚¹æ£€" Command="{Binding CompleteCommand}" Style="{StaticResource SuccessBtn}"/>
            </HorizontalStackLayout>

            <!-- åŸºç¡€ä¿¡æ¯ -->
            <Label Text="ç‚¹å·¡æ£€å•åŸºç¡€ä¿¡æ¯" Style="{StaticResource SectionTitle}"/>
            <Frame Style="{StaticResource Card}">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,*" ColumnSpacing="10" RowSpacing="6">

                    <Label Grid.Row="0" Grid.Column="0" Text="ç‚¹æ£€å•å·ï¼š" />
                    <Label Grid.Row="0" Grid.Column="1" Text="{Binding Detail.qualityNo}" />

                    <Label Grid.Row="1" Grid.Column="0" Text="è®¾å¤‡åç§°ï¼š" />
                    <Label Grid.Row="1" Grid.Column="1" Text="{Binding Detail.materialName}" />

                    <Label Grid.Row="2" Grid.Column="0" Text="ç‚¹æ£€æ—¥æœŸï¼š" />
                    <DatePicker Grid.Row="2" Grid.Column="1"
                                Date="{Binding Detail.inspectDate, Mode=TwoWay}"
                                HorizontalOptions="Start"/>

                    <Label Grid.Row="3" Grid.Column="0" Text="å¤‡æ³¨ï¼š" />
                    <Entry Grid.Row="3" Grid.Column="1"
                           Text="{Binding Detail.inspectRemark, Mode=TwoWay}" />
                </Grid>
            </Frame>

            <!-- æ£€éªŒç»“æžœ -->
            <Label Text="æ£€éªŒç»“æžœ" Style="{StaticResource SectionTitle}"/>
            <Frame Style="{StaticResource Card}">
                <Grid ColumnDefinitions="120,*" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8" ColumnSpacing="8">

                    <Label Grid.Row="0" Grid.Column="0" Text="æ£€éªŒç»“æžœï¼š" />
                    <Picker Grid.Row="0" Grid.Column="1"
                            ItemsSource="{Binding InspectResultOptions}"
                            ItemDisplayBinding="{Binding Text}"
                            SelectedItem="{Binding SelectedInspectResult, Mode=TwoWay}"/>

                    <Label Grid.Row="1" Grid.Column="0" Text="åˆæ ¼é¡¹ç›®æ•°ï¼š" />
                    <Label Grid.Row="1" Grid.Column="1" Text="{Binding Detail.qualifiedNum}" />

                    <Label Grid.Row="2" Grid.Column="0" Text="ä¸åˆæ ¼é¡¹ç›®æ•°ï¼š" />
                    <Label Grid.Row="2" Grid.Column="1" Text="{Binding Detail.unqualifiedNum}" 
                           TextColor="{Binding IsUnqualifiedSelected, Converter={toolkit:BoolToObjectConverter TrueObject=Red, FalseObject=#111827}}"/>

                    <Label Grid.Row="3" Grid.Column="0" Text="æ£€éªŒå‘˜ï¼š" />
                    <Grid Grid.Row="3" Grid.Column="1">
                        <Entry x:Name="InspectorEntry"
                               Text="{Binding InspectorText, Mode=TwoWay}"
                               Placeholder="è¾“å…¥å§“å/è´¦å·ç­›é€‰"
                               Completed="OnInspectorEntryCompleted"/>
                        <!-- ä¸‹æ‹‰æµ®å±‚ -->
                        <Frame HasShadow="True" Padding="0" Margin="0,40,0,0"
                               IsVisible="{Binding IsInspectorDropdownOpen}"
                               ZIndex="9999" CornerRadius="8"
                               BackgroundColor="White" BorderColor="#E5E7EB">
                            <CollectionView ItemsSource="{Binding InspectorSuggestions}" HeightRequest="220">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="10" ColumnDefinitions="Auto,*">
                                            <Label Grid.Column="0" Text="ðŸ‘¤"/>
                                            <Label Grid.Column="1" Text="{Binding realname}"/>
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PickInspectorCommand}"
                                                    CommandParameter="{Binding .}"/>
                                            </Grid.GestureRecognizers>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Frame>
                    </Grid>
                </Grid>
            </Frame>

            <!-- ç‚¹æ£€é¡¹ç›®æ‰§è¡Œ -->
            <Label Text="ç‚¹æ£€é¡¹ç›®æ‰§è¡Œ" Style="{StaticResource SectionTitle}"/>
            <Frame Style="{StaticResource Card}">
                <VerticalStackLayout Spacing="8">

                    <HorizontalStackLayout HorizontalOptions="End">
                        <Button Text="ä¸€é”®åˆæ ¼" Command="{Binding SetAllQualifiedCommand}" Style="{StaticResource PrimaryBtn}"/>
                    </HorizontalStackLayout>

                    <!-- è¡¨å¤´ -->
                    <Grid Style="{StaticResource TableHeader}"
                          ColumnDefinitions="50,*,120,140,*,140" >
                        <Label Grid.Column="0" Text="åºå·" />
                        <Label Grid.Column="1" Text="æ£€æŸ¥å†…å®¹" />
                        <Label Grid.Column="2" Text="æ ‡å‡†å€¼" />
                        <Label Grid.Column="3" Text="æ£€éªŒç»“æžœ" />
                        <Label Grid.Column="4" Text="ç¼ºé™·" />
                        <Label Grid.Column="5" Text="å¤‡æ³¨" />
                    </Grid>

                    <!-- è¡Œ -->
                    <CollectionView ItemsSource="{Binding Items}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8,6"
                                      ColumnDefinitions="50,*,120,140,*,140"
                                      RowDefinitions="Auto" ColumnSpacing="8" >
                                    <Label Grid.Column="0" Text="{Binding index}" HorizontalTextAlignment="Center"/>
                                    <Label Grid.Column="1" Text="{Binding checkContent}" LineBreakMode="WordWrap"/>

                                    <Label Grid.Column="2" Text="{Binding standardVal}" />

                                    <Picker Grid.Column="3"
                                            ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.InspectResultOptions}"
                                            ItemDisplayBinding="{Binding Text}"
                                            SelectedItem="{Binding inspectResult, Mode=TwoWay}"/>

                                    <!-- ç¼ºé™· chips + é€‰æ‹©æŒ‰é’® -->
                                    <HorizontalStackLayout Grid.Column="4" Spacing="6">
                                        <FlexLayout BindableLayout.ItemsSource="{Binding SelectedDefects}"
                                                    Direction="Row" Wrap="Wrap" AlignItems="Center">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate>
                                                    <Frame Padding="8,4" Margin="0,0,6,6" HasShadow="False"
                                                           CornerRadius="6" BorderColor="#E5E7EB"
                                                           BackgroundColor="{Binding ColorHex}">
                                                        <Label Text="{Binding Name}" FontSize="12"/>
                                                    </Frame>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </FlexLayout>
                                        <Button Text="é€‰æ‹©" HeightRequest="28"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.OpenDefectPickerCommand}"
                                                CommandParameter="{Binding .}"/>
                                    </HorizontalStackLayout>

                                    <Entry Grid.Column="5" Text="{Binding remark, Mode=TwoWay}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- å›¾ç‰‡é™„ä»¶ -->
            <Label Text="å›¾ç‰‡é™„ä»¶" Style="{StaticResource SectionTitle}"/>
            <Frame Style="{StaticResource Card}">
                <VerticalStackLayout Spacing="8">
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="ï¼‹ ä¸Šä¼ å›¾ç‰‡"  Clicked="OnPickImagesClicked"  Style="{StaticResource PrimaryBtn}"/>
                    </HorizontalStackLayout>

                    <CollectionView ItemsSource="{Binding ImageAttachments}"
                                    ItemsLayout="HorizontalList" HeightRequest="96" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Frame Padding="0" WidthRequest="96" HeightRequest="96" CornerRadius="8"
                                           HasShadow="False" BorderColor="#E5E7EB" Margin="0,0,6,0">
                                        <Image Aspect="AspectFill" Source="{Binding PreviewUrl}">
                                            <Image.Triggers>
                                                <DataTrigger TargetType="Image" Binding="{Binding PreviewUrl}" Value="{x:Null}">
                                                    <Setter Property="Source" Value="{Binding LocalPath}"/>
                                                </DataTrigger>
                                            </Image.Triggers>
                                        </Image>
                                    </Frame>
                                    <Button Text="Ã—"
                                            Padding="0" WidthRequest="22" HeightRequest="22"
                                            BackgroundColor="#EF4444" TextColor="White"
                                            CornerRadius="11"
                                            HorizontalOptions="End" VerticalOptions="Start"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteAttachmentAsyncCommand}"
                                            CommandParameter="{Binding .}"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Label Text="æš‚æ— å›¾ç‰‡é™„ä»¶" IsVisible="{Binding ImageAttachments.Count, Converter={toolkit:IntToBoolConverter}, ConverterParameter=Zero}" TextColor="#9CA3AF"/>
                </VerticalStackLayout>
            </Frame>

            <!-- å…¶ä»–é™„ä»¶ -->
            <Label Text="æ–‡ä»¶é™„ä»¶" Style="{StaticResource SectionTitle}"/>
            <Frame Style="{StaticResource Card}">
                <VerticalStackLayout Spacing="8">
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="ï¼‹ ä¸Šä¼ é™„ä»¶"  Clicked="OnPickFileClicked" Style="{StaticResource PrimaryBtn}"/>
                    </HorizontalStackLayout>

                    <!-- è¡¨å¤´ -->
                    <Grid Style="{StaticResource TableHeader}" ColumnDefinitions="50,*,120,140,120">
                        <Label Grid.Column="0" Text="åºå·"/>
                        <Label Grid.Column="1" Text="é™„ä»¶åç§°"/>
                        <Label Grid.Column="2" Text="å¤§å°"/>
                        <Label Grid.Column="3" Text="ä¸Šä¼ æ—¶é—´"/>
                        <Label Grid.Column="4" Text="æ“ä½œ"/>
                    </Grid>

                    <CollectionView ItemsSource="{Binding Attachments}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8,6" ColumnDefinitions="50,*,120,140,120" ColumnSpacing="8">
                                    <Label Grid.Column="0" Text="{Binding index}">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding .}" Value="{x:Null}">
                                                <Setter Property="Text" Value="{x:Reference Self}"/>
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                    <Label Grid.Column="1" Text="{Binding AttachmentName}" LineBreakMode="TailTruncation"/>
                                    <Label Grid.Column="2" Text="{Binding AttachmentSize}"/>
                                    <Label Grid.Column="3" Text="{Binding CreatedTime}"/>
                                    <HorizontalStackLayout Grid.Column="4" Spacing="8">
                                        <Button Text="é¢„è§ˆ" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DownloadAttachmentCommand}" CommandParameter="{Binding .}"/>
                                        <Button Text="åˆ é™¤" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteAttachmentAsyncCommand}" CommandParameter="{Binding .}"/>
                                    </HorizontalStackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Label Text="æš‚æ— æ–‡ä»¶é™„ä»¶" IsVisible="{Binding Attachments.Count, Converter={toolkit:IntToBoolConverter}, ConverterParameter=Zero}" TextColor="#9CA3AF"/>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
    </Grid>
</ContentPage>
